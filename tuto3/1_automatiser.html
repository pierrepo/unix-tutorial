

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Automatiser l’analyse RNA-seq avec un cluster 🚀 &#8212; Unix tutorial</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tuto3/1_automatiser';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compter ⏲ les heures, surveiller 📬 les jobs et récupérer 📥 les résultats" href="2_compter_surveiller_recuperer.html" />
    <link rel="prev" title="Introduction et contexte" href="0_intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Bienvenue !
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">JupyterHub du cluster IFB</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../connection.html">Connexion au JupyterHub de l’IFB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gestion_compte_ifb.html">Gestion de votre compte utilisateur sur le cluster de calcul</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction à Unix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../tuto1/tutorial.html">Un  aperçu du shell Unix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../more.html">Ressources complémentaires</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analyse RNA-seq avec Unix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../tuto2/0_intro.html">Introduction et contexte</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuto2/1_preparer_logiciels_module.html">Préparer l’environnement logiciel 🧰</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuto2/2_preparer_donnees.html">Préparer les données 🗃️</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuto2/3_analyser.html">Analyser les données RNA-seq 💻</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuto2/4_automatiser.html">Automatiser l’analyse RNA-seq ⚙️</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analyse RNA-seq avec un cluster de calcul</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="0_intro.html">Introduction et contexte</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Automatiser l’analyse RNA-seq avec un cluster 🚀</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_compter_surveiller_recuperer.html">Compter ⏲ les heures, surveiller 📬 les jobs et récupérer 📥 les résultats</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_automatiser_snakemake.html">Automatiser avec Snakemake 🐍 ⚙</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/pierrepo/unix-tutorial" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/pierrepo/unix-tutorial/edit/master/docs/tuto3/1_automatiser.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/pierrepo/unix-tutorial/issues/new?title=Issue%20on%20page%20%2Ftuto3/1_automatiser.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tuto3/1_automatiser.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Automatiser l’analyse RNA-seq avec un cluster 🚀</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decouvrir-le-cluster">Découvrir le cluster</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analyser-un-echantillon">Analyser un échantillon</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analyser-50-echantillons-ou-pas-loin">Analyser 50 échantillons (ou pas loin)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparer-les-donnees">Préparer les données</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lancer-le-script-de-l-etape-1">Lancer le script de l’étape 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lancer-le-script-de-l-etape-2">Lancer le script de l’étape 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lancer-le-script-de-l-etape-3">Lancer le script de l’étape 3</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bilan">Bilan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aller-plus-loin-connecter-les-jobs">Aller plus loin : connecter les jobs</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="automatiser-l-analyse-rna-seq-avec-un-cluster">
<h1><a class="toc-backref" href="#id1" role="doc-backlink">Automatiser l’analyse RNA-seq avec un cluster 🚀</a><a class="headerlink" href="#automatiser-l-analyse-rna-seq-avec-un-cluster" title="Permalink to this heading">#</a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#automatiser-l-analyse-rna-seq-avec-un-cluster" id="id1">Automatiser l’analyse RNA-seq avec un cluster 🚀</a></p>
<ul>
<li><p><a class="reference internal" href="#decouvrir-le-cluster" id="id2">Découvrir le cluster</a></p></li>
<li><p><a class="reference internal" href="#analyser-un-echantillon" id="id3">Analyser un échantillon</a></p></li>
<li><p><a class="reference internal" href="#analyser-50-echantillons-ou-pas-loin" id="id4">Analyser 50 échantillons (ou pas loin)</a></p>
<ul>
<li><p><a class="reference internal" href="#preparer-les-donnees" id="id5">Préparer les données</a></p></li>
<li><p><a class="reference internal" href="#lancer-le-script-de-l-etape-1" id="id6">Lancer le script de l’étape 1</a></p></li>
<li><p><a class="reference internal" href="#lancer-le-script-de-l-etape-2" id="id7">Lancer le script de l’étape 2</a></p></li>
<li><p><a class="reference internal" href="#lancer-le-script-de-l-etape-3" id="id8">Lancer le script de l’étape 3</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#bilan" id="id9">Bilan</a></p></li>
<li><p><a class="reference internal" href="#aller-plus-loin-connecter-les-jobs" id="id10">Aller plus loin : connecter les jobs</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="decouvrir-le-cluster">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Découvrir le cluster</a><a class="headerlink" href="#decouvrir-le-cluster" title="Permalink to this heading">#</a></h2>
<p>Un cluster de calcul met à disposition de ses utilisateurs des processeurs et de la mémoire vive pour réaliser des calculs. Ces ressouces sont réparties sur plusieurs machines, appelées <em>nœuds de calcul</em>. Chaque nœud de calcul contient plusieurs dizaines de processeurs (ou coeurs) et plusieurs centaines de Go de mémoire vive.</p>
<p>Plusieurs utilisateurs utilisent simultanément un cluster de calcul. Pour vous en rendre compte, dans JupyterLab, ouvrez un terminal puis entrez la commande suivante qui va lister tous les calculs (appelés <em>job</em>) en cours sur le cluster :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>squeue<span class="w"> </span>-t<span class="w"> </span>RUNNING
</pre></div>
</div>
<div class="tip admonition">
<p class="admonition-title">Rappel</p>
<p>Ne tapez pas le caractère <code class="docutils literal notranslate"><span class="pre">$</span></code> en début de ligne et faites bien attention aux majuscules et au minuscules.</p>
</div>
<p>Vous voyez que vous n’êtes pas seul ! Comptez maintenant le nombre de jobs en cours d’exécution en chaînant la commande précédente avec <code class="docutils literal notranslate"><span class="pre">wc</span> <span class="pre">-l</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>squeue<span class="w"> </span>-t<span class="w"> </span>RUNNING<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</pre></div>
</div>
<p>Vous pouvez aussi compter le nombre de jobs en attente d’exécution :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>squeue<span class="w"> </span>-t<span class="w"> </span>PENDING<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</pre></div>
</div>
<p>Et vous alors ? Avez-vous lancé un calcul ? Vérifiez-le en entrant la commande suivante pour lister les calculs associés à votre compte :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>squeue<span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span>
</pre></div>
</div>
<p>La colonne <code class="docutils literal notranslate"><span class="pre">ST</span></code> indique le statut de votre job :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CA</span></code> (<em>cancelled</em>) : le job a été annulé</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">F</span></code> (<em>failed</em>) : le job a planté</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PD</span></code> (<em>pending</em>) : le job est en attente que des ressources soient disponibles</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">R</span></code> (<em>running</em>) : le job est en cours d’exécution</p></li>
</ul>
<p>Bizarre ! Vous avez un job avec le statut <em>running</em> en cours d’exécution alors que vous n’avez a priori rien lancé 🤔</p>
<p>En fait, le JupyterLab dans lequel vous êtes est lui-même un job lancé sur le cluster. C’est d’ailleurs pour cela qu’avant de lancer JupyterLab, vous avez dû préciser le compte à utiliser (<code class="docutils literal notranslate"><span class="pre">202304_duo</span></code>) et choisir le nombre de processeurs et la quantité de mémoire vive dont vous aviez besoin. Finalement, vous étiez dans la matrice sans même le savoir 😱</p>
<p>Comme plusieurs utilisateurs peuvent lancer des jobs sur un cluster, un gestionnaire de jobs (ou ordonnanceur) s’occupe de répartir les ressources entre les différents utilisateurs. Sur le cluster de l’IFB, le gestionnaire de jobs est <a class="reference external" href="https://slurm.schedmd.com/">Slurm</a>. Désormais le lancement de vos analyses se fera via Slurm.</p>
</section>
<section id="analyser-un-echantillon">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Analyser un échantillon</a><a class="headerlink" href="#analyser-un-echantillon" title="Permalink to this heading">#</a></h2>
<p>Déplacez-vous le répertoire <code class="docutils literal notranslate"><span class="pre">/shared/projects/202304_duo/$USER/rnaseq</span></code> puis vérifiez que vous êtes dans le bon répertoire avec la commande <code class="docutils literal notranslate"><span class="pre">pwd</span></code>.</p>
<p>Supprimez les répertoires qui contiennent les résultats d’une éventuelle précédente analyse :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>genome_index<span class="w"> </span>reads_qc<span class="w"> </span>reads_map<span class="w"> </span>counts
</pre></div>
</div>
<p>Téléchargez dans un terminal de JupyterLab un premier script Bash (<a class="reference download internal" download="" href="../_downloads/517e48be1a6181a524447b0a8b23023e/script_cluster_0.sh"><span class="xref download myst"><code class="docutils literal notranslate"><span class="pre">script_cluster_0.sh</span></code></span></a>) avec la commande <code class="docutils literal notranslate"><span class="pre">wget</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>wget<span class="w"> </span>https://raw.githubusercontent.com/pierrepo/unix-tutorial/master/tuto3/script_cluster_0.sh
</pre></div>
</div>
<p>Ce script correspond au script <code class="docutils literal notranslate"><span class="pre">script_local_2.sh</span></code> adapté pour une utilisation sur un cluster. Ouvrez le script <code class="docutils literal notranslate"><span class="pre">script_cluster_0.sh</span></code> avec l’éditeur de texte de JupyterLab et essayez d’identifier les différences avec <code class="docutils literal notranslate"><span class="pre">script_local_2.sh</span></code>.</p>
<ol class="arabic">
<li><p>Au début du script, deux lignes sont nouvelles :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH --mem=2G</span>
<span class="c1">#SBATCH --cpus-per-task=8</span>
</pre></div>
</div>
<p>Ces lignes commencent par le caractère <code class="docutils literal notranslate"><span class="pre">#</span></code> qui indique qu’il s’agit de commentaires pour Bash, elles seront donc ignorées par le <em>shell</em>. Par contre, elles ont un sens très particulier pour le gestionnaire de jobs du cluster Slurm. Ici, ces lignes indiquent à Slurm que le job a besoin de 2 Go de mémoire vive et de 8 processeurs pour s’exécuter.</p>
</li>
<li><p>Un peu plus loin, on indique explicitement les modules (les logiciels) à charger avec leurs versions :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>fastqc/0.11.9
module<span class="w"> </span>load<span class="w"> </span>star/2.7.9a
module<span class="w"> </span>load<span class="w"> </span>samtools/1.14
module<span class="w"> </span>load<span class="w"> </span>htseq/0.13.5
module<span class="w"> </span>load<span class="w"> </span>cufflinks/2.2.1
</pre></div>
</div>
</li>
<li><p>L’appel aux différents programmes (<code class="docutils literal notranslate"><span class="pre">STAR</span></code>, <code class="docutils literal notranslate"><span class="pre">fastqc</span></code>, <code class="docutils literal notranslate"><span class="pre">samtools</span></code>…) est préfixé par l’instruction <code class="docutils literal notranslate"><span class="pre">srun</span></code> qui va explicitement indiquer à Slurm qu’il s’agit d’un sous-job. Nous en verrons l’utilité plus tard.</p></li>
<li><p>Pour STAR, l’indication du nombre de coeurs à utiliser est défini sous la forme :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>srun<span class="w"> </span>STAR<span class="w"> </span>--runThreadN<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SLURM_CPUS_PER_TASK</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>La variable <code class="docutils literal notranslate"><span class="pre">SLURM_CPUS_PER_TASK</span></code> est utilisée pour indiquer à STAR le nombre de processeurs à utiliser. Cette variable est automatiquement définie par Slurm lors de l’exécution du script et la lecture de l’instruction <code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">--cpus-per-task=8</span></code>. Dans le cas présent, elle vaut 8.</p>
</li>
</ol>
<p>Lancez enfin le script avec la commande suivante :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>script_cluster_0.sh
</pre></div>
</div>
<p>Vous devriez obtenir un message du type <code class="docutils literal notranslate"><span class="pre">Submitted</span> <span class="pre">batch</span> <span class="pre">job</span> <span class="pre">33389786</span></code>. Ici, <code class="docutils literal notranslate"><span class="pre">33389786</span></code> correspond au numéro du job. Notez bien le numéro de votre job.</p>
<ul class="simple">
<li><p>L’instruction <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> est la manière de demander à Slurm de lancer un script.</p></li>
<li><p>L’option <code class="docutils literal notranslate"><span class="pre">-A</span> <span class="pre">202304_duo</span></code> spécifie quel projet utiliser (facturer) pour cette commande. Un même utilisateur peut appartenir à plusieurs projets. Le nombre d’heures de calcul attribuées à un projet étant limité, il est important de savoir quel projet imputer pour telle ou telle commande. Pensez-y pour vos futurs projets.</p></li>
</ul>
<p>Vérifiez que votre script est en train de tourner avec la commande :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>squeue<span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span>
</pre></div>
</div>
<p>Le statut du job devrait être <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code>.</p>
<p>Et pour avoir plus de détails, utilisez la commande :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sacct<span class="w"> </span>--format<span class="o">=</span>JobID,JobName,State,Start,Elapsed,CPUTime,NodeList<span class="w"> </span>-j<span class="w"> </span>JOBID
</pre></div>
</div>
<p>avec <code class="docutils literal notranslate"><span class="pre">JOBID</span></code> (en fin de ligne) le numéro du job à remplacer par le vôtre.</p>
<p>Voici un exemple de sortie que vous pourriez obtenir :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  sacct --format=JobID,JobName,State,Start,Elapsed,CPUTime,NodeList -j 33389786
       JobID    JobName      State               Start    Elapsed    CPUTime        NodeList 
------------ ---------- ---------- ------------------- ---------- ---------- --------------- 
33389786     script_cl+    RUNNING 2023-05-12T10:25:21   00:00:46   00:06:08     cpu-node-11 
33389786.ba+      batch    RUNNING 2023-05-12T10:25:21   00:00:46   00:06:08     cpu-node-11 
33389786.0         STAR  COMPLETED 2023-05-12T10:25:23   00:00:08   00:01:04     cpu-node-11 
33389786.1       fastqc    RUNNING 2023-05-12T10:25:31   00:00:36   00:04:48     cpu-node-11 
</pre></div>
</div>
<p>Quand la colonne <em>State</em> est à <code class="docutils literal notranslate"><span class="pre">COMPLETED</span></code>, cela signifie que le sous-job est terminé. Un sous-job est créé à chaque fois que la commande <code class="docutils literal notranslate"><span class="pre">srun</span></code> est utilisée dans le script de soumission. Ici, on voit que le sous-job <code class="docutils literal notranslate"><span class="pre">STAR</span></code> est terminé, mais que le sous-job <code class="docutils literal notranslate"><span class="pre">fastqc</span></code> est toujours en cours d’exécution.</p>
<p>Relancez régulièrement la commande précédente pour suivre l’avancement de votre job.</p>
<p>Notez le moment où vous avez terminé l’alignement sur le génome de référence, c’est-à-dire que vous avez obtenu un second sous-job <code class="docutils literal notranslate"><span class="pre">STAR</span></code> avec le statut <code class="docutils literal notranslate"><span class="pre">COMPLETED</span></code> dans la sortie renvoyée par <code class="docutils literal notranslate"><span class="pre">sacct</span></code>. Par exemple :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  sacct --format=JobID,JobName,State,Start,Elapsed,CPUTime,NodeList -j 33389786
       JobID    JobName      State               Start    Elapsed    CPUTime        NodeList 
------------ ---------- ---------- ------------------- ---------- ---------- --------------- 
33389786     script_cl+    RUNNING 2023-05-12T10:25:21   00:03:25   00:27:20     cpu-node-11 
33389786.ba+      batch    RUNNING 2023-05-12T10:25:21   00:03:25   00:27:20     cpu-node-11 
33389786.0         STAR  COMPLETED 2023-05-12T10:25:23   00:00:08   00:01:04     cpu-node-11 
33389786.1       fastqc  COMPLETED 2023-05-12T10:25:31   00:01:23   00:11:04     cpu-node-11 
33389786.2         STAR  COMPLETED 2023-05-12T10:26:54   00:01:36   00:12:48     cpu-node-11 
33389786.3     samtools    RUNNING 2023-05-12T10:28:30   00:00:16   00:02:08     cpu-node-11 
</pre></div>
</div>
<p>Nous ne souhaitons pas poursuivre plus longtemps cette analyse car cela prendrait trop de temps.</p>
<p>Stoppez le job en cours avec la commande :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>scancel<span class="w"> </span>JOBID
</pre></div>
</div>
<p>avec <code class="docutils literal notranslate"><span class="pre">JOBID</span></code> le numéro de votre job.</p>
<p>Vérifiez avec la commande <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">-u</span> <span class="pre">$USER</span></code> que votre job ne tourne plus.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Le fichier <code class="docutils literal notranslate"><span class="pre">slurm-JOBID.out</span></code> (avec <code class="docutils literal notranslate"><span class="pre">JOBID</span></code> le numéro de votre job) contient le « journal » de votre job. C’est-à-dire tout ce qui s’affiche habituellement à l’écran a été enregistré dans ce fichier.</p>
<p>Ouvrez ce fichier avec l’éditeur de texte de JupyterLab pour vous en rendre compte.</p>
</div>
</section>
<section id="analyser-50-echantillons-ou-pas-loin">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Analyser 50 échantillons (ou pas loin)</a><a class="headerlink" href="#analyser-50-echantillons-ou-pas-loin" title="Permalink to this heading">#</a></h2>
<p>Maintenant que nous savons comment analyser un échantillon avec un cluster de calcul, nous allons automatiser l’analyse de 50 échantillons. Mais pour cela nous prendre plusieurs précautions :</p>
<ul class="simple">
<li><p>Nous allons séparer les étapes suivantes :</p>
<ol class="arabic simple">
<li><p>Indexer le génome de référence – ne doit ce que faire une seule fois.</p></li>
<li><p>Contrôler la qualité, aligner et quantifier les <em>reads</em> – qui doit se faire pour chaque échantillon, donc 50 fois.</p></li>
<li><p>Normaliser les comptages de tous les échantillons ensemble – ne doit ce que faire une seule fois.</p></li>
</ol>
</li>
<li><p>L’étape 2 ne doit pas se faire successivement pour chaque échantillon, mais en parallèle. C’est-à-dire qu’on souhaite idéalement lancer l’analyse des 50 échantillons <strong>en même temps</strong>.</p></li>
</ul>
<section id="preparer-les-donnees">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Préparer les données</a><a class="headerlink" href="#preparer-les-donnees" title="Permalink to this heading">#</a></h3>
<p>Nous avons téléchargé pour vous les 50 échantillons (fichiers .fastq.gz) ainsi que le génome de référence et ses annotations dans le répertoire <code class="docutils literal notranslate"><span class="pre">/shared/projects/202304_duo/data/rnaseq_scere</span></code>. Vérifiez son contenu avec la commande :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>tree<span class="w"> </span>/shared/projects/202304_duo/data/rnaseq_scere
</pre></div>
</div>
</section>
<section id="lancer-le-script-de-l-etape-1">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Lancer le script de l’étape 1</a><a class="headerlink" href="#lancer-le-script-de-l-etape-1" title="Permalink to this heading">#</a></h3>
<p>Supprimez les répertoires qui contiennent les résultats d’une éventuelle précédente analyse :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>genome_index<span class="w"> </span>reads_qc<span class="w"> </span>reads_map<span class="w"> </span>counts<span class="w"> </span>slurm*.out
</pre></div>
</div>
<p>Téléchargez dans un terminal de JupyterLab le script Bash (<a class="reference download internal" download="" href="../_downloads/c3187cdf0191618760ed0e4163360193/script_cluster_1.sh"><span class="xref download myst"><code class="docutils literal notranslate"><span class="pre">script_cluster_1.sh</span></code></span></a>) avec la commande <code class="docutils literal notranslate"><span class="pre">wget</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>wget<span class="w"> </span>https://raw.githubusercontent.com/pierrepo/unix-tutorial/master/tuto3/script_cluster_1.sh
</pre></div>
</div>
<p>Ouvrez ce script avec l’éditeur de texte de JupyterLab et essayez d’identifier comment sont définies les variables <code class="docutils literal notranslate"><span class="pre">base_dir</span></code> et <code class="docutils literal notranslate"><span class="pre">data_dir</span></code>.</p>
<p>Puis lancez le script en n’oubliant pas d’indiquer explicitement le compte à utiliser (<code class="docutils literal notranslate"><span class="pre">202304_duo</span></code>) :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>script_cluster_1.sh
</pre></div>
</div>
<p>Vérifiez avec les commandes <code class="docutils literal notranslate"><span class="pre">squeue</span></code> et <code class="docutils literal notranslate"><span class="pre">sacct</span></code> que le job est lancé et se termine correctement (normalement rapidement).</p>
</section>
<section id="lancer-le-script-de-l-etape-2">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Lancer le script de l’étape 2</a><a class="headerlink" href="#lancer-le-script-de-l-etape-2" title="Permalink to this heading">#</a></h3>
<p>Téléchargez dans un terminal de JupyterLab le script Bash (<a class="reference download internal" download="" href="../_downloads/5a5d8fac92614335d844f7ff5c822398/script_cluster_2.sh"><span class="xref download myst"><code class="docutils literal notranslate"><span class="pre">script_cluster_2.sh</span></code></span></a>) avec la commande <code class="docutils literal notranslate"><span class="pre">wget</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>wget<span class="w"> </span>https://raw.githubusercontent.com/pierrepo/unix-tutorial/master/tuto3/script_cluster_2.sh
</pre></div>
</div>
<p>Ouvrez ce script avec l’éditeur de texte de JupyterLab. Notez en début de script la ligne</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH --array=0-49 </span>
</pre></div>
</div>
<p>qui nous permettra de créer un <em>job array</em>, c’est-à-dire un ensemble de 50 (de 0 à 49 inclus) jobs qui vont être lancés en parallèle.</p>
<p>Pour chacun des jobs, on lui attribue un échantillon avec les commandes suivantes :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># liste de tous les fichiers .fastq.gz dans un tableau</span>
<span class="nv">fastq_files</span><span class="o">=(</span><span class="si">${</span><span class="nv">fastq_dir</span><span class="si">}</span>/*fastq.gz<span class="o">)</span>
<span class="c1"># extraction de l&#39;identifiant de l&#39;échantillon</span>
<span class="c1"># à partir du nom de fichier : /shared/projects/202304_duo/data/rnaseq_scere/reads/SRR3405783.fastq.gz</span>
<span class="c1"># on extrait : SRR3405783</span>
<span class="nv">sample</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span>-s<span class="w"> </span>.fastq.gz<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">fastq_files</span><span class="p">[</span><span class="nv">$SLURM_ARRAY_TASK_ID</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>
</pre></div>
</div>
<p>Cette étape est importante car elle permet de savoir quel échantillon traiter pour chaque job. Par exemple, le job 0 va être associé à l’échantillon <code class="docutils literal notranslate"><span class="pre">SRR3405783</span></code> (le premier par ordre alphabétique).</p>
<p>Pour ne pas emboliser le cluster et pour que tout le monde puisse obtenir des résultats rapidement, modifiez la ligne</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH --array=0-49 </span>
</pre></div>
</div>
<p>par</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH --array=0-2</span>
</pre></div>
</div>
<p>Vous n’analyserez que 3 échantillons dans 3 jobs en parallèle. Pensez à sauvegarder vos modifications.</p>
<p>Lancez enfin le script :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>script_cluster_2.sh
</pre></div>
</div>
<p>Suivez la progression de vos jobs avec la commande :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sacct<span class="w"> </span>--format<span class="o">=</span>JobID,JobName,State,Start,Elapsed,CPUTime,NodeList<span class="w"> </span>-j<span class="w"> </span>JOBID
</pre></div>
</div>
<p>avec <code class="docutils literal notranslate"><span class="pre">JOBID</span></code> le numéro de votre job.</p>
<p>Plutôt que de relancer en permanence la commande <code class="docutils literal notranslate"><span class="pre">sacct</span></code> vous pouvez demander à la commande <code class="docutils literal notranslate"><span class="pre">watch</span></code> d’afficher les éventuels changements :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>watch<span class="w"> </span>sacct<span class="w"> </span>--format<span class="o">=</span>JobID,JobName,State,Start,Elapsed,CPUTime,NodeList<span class="w"> </span>-j<span class="w"> </span>JOBID
</pre></div>
</div>
<p>Vous devriez obtenir un affichage du type :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Every</span> <span class="mf">2.0</span><span class="n">s</span><span class="p">:</span> <span class="n">sacct</span> <span class="o">--</span><span class="nb">format</span><span class="o">=</span><span class="n">JobID</span><span class="p">,</span><span class="n">JobName</span><span class="p">,</span><span class="n">State</span><span class="p">,</span><span class="n">Start</span><span class="p">,</span><span class="n">Elapsed</span><span class="p">,</span><span class="n">CPUTime</span><span class="p">,</span><span class="n">NodeList</span> <span class="o">-</span><span class="n">j</span> <span class="o">...</span>  <span class="n">Wed</span> <span class="n">May</span> <span class="mi">10</span> <span class="mi">22</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">53</span> <span class="mi">2023</span>

       <span class="n">JobID</span>    <span class="n">JobName</span>      <span class="n">State</span>               <span class="n">Start</span>    <span class="n">Elapsed</span>    <span class="n">CPUTime</span>        <span class="n">NodeList</span>
<span class="o">------------</span> <span class="o">----------</span> <span class="o">----------</span> <span class="o">-------------------</span> <span class="o">----------</span> <span class="o">----------</span> <span class="o">---------------</span>
<span class="mi">33361021_0</span>   <span class="n">script_cl</span><span class="o">+</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">54</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">52</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">20</span>
<span class="mf">33361021_0.</span><span class="o">+</span>      <span class="n">batch</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">54</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">52</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">20</span>
<span class="mf">33361021_0.0</span>     <span class="n">fastqc</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">56</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">57</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">36</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">20</span>
<span class="mi">33361021_1</span>   <span class="n">script_cl</span><span class="o">+</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">54</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">52</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">23</span>
<span class="mf">33361021_1.</span><span class="o">+</span>      <span class="n">batch</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">54</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">52</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">23</span>
<span class="mf">33361021_1.0</span>     <span class="n">fastqc</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">56</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">57</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">36</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">23</span>
<span class="mi">33361021_2</span>   <span class="n">script_cl</span><span class="o">+</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">54</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">52</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">25</span>
<span class="mf">33361021_2.</span><span class="o">+</span>      <span class="n">batch</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">54</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">52</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">25</span>
<span class="mf">33361021_2.0</span>     <span class="n">fastqc</span>    <span class="n">RUNNING</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span><span class="n">T22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">56</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">57</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">36</span>     <span class="n">cpu</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mi">25</span>
</pre></div>
</div>
<p>On apprend ici que 3 jobs sont en cours d’exécution (<code class="docutils literal notranslate"><span class="pre">RUNNING</span></code>) et qu’ils sont appelés <code class="docutils literal notranslate"><span class="pre">33361021_0</span></code>, <code class="docutils literal notranslate"><span class="pre">33361021_1</span></code> et <code class="docutils literal notranslate"><span class="pre">33361021_2</span></code>. Chacun de ces jobs a été lancé sur un noeud de calcul différent (<code class="docutils literal notranslate"><span class="pre">cpu-node-20</span></code>, <code class="docutils literal notranslate"><span class="pre">cpu-node-23</span></code> et <code class="docutils literal notranslate"><span class="pre">cpu-node-25</span></code>) mais cela aurait pu être le même. Chaque job est décomposé en sous-jobs, pour le moment à l’étape <code class="docutils literal notranslate"><span class="pre">fastqc</span></code>.</p>
<p>Le temps que les 3 jobs se terminent, profitez-en pour faire une pause café ☕️ bien méritée.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Utilisez la combinaison de touches <kbd>Ctrl</kbd> + <kbd>C</kbd> pour arrêter la commande <code class="docutils literal notranslate"><span class="pre">watch</span></code>.</p>
</div>
<p>Quand tous les jobs sont à <code class="docutils literal notranslate"><span class="pre">COMPLETED</span></code>, comparez le temps d’exécution de chacun (dans le colonne <em>Elapsed</em> au niveau des lignes <em>script_cl+</em>). Ce temps d’exécution devrait être compris entre 20 et 25 min, ce qui est équivalent au temps d’exécution du script <code class="docutils literal notranslate"><span class="pre">script_local_2.sh</span></code> pour un <strong>seul échantillon</strong>. C’est tout l’intérêt de lancer des jobs en parallèle.</p>
<p>Remarquez que le temps CPU (<code class="docutils literal notranslate"><span class="pre">CPUTime</span></code>) qui correspond au temps de calcul consommé par tous les processeurs est supérieur au temps « humain » (<em>Elapsed</em>). Ainsi, si vous avez lancé un job avec 8 coeurs qui se termine en 1 heure, la consommation CPU sera de 8 coeurs x 1 heure = 8 heures. Sur un cluster, c’est toujours le temps CPU qui est facturé.</p>
</section>
<section id="lancer-le-script-de-l-etape-3">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Lancer le script de l’étape 3</a><a class="headerlink" href="#lancer-le-script-de-l-etape-3" title="Permalink to this heading">#</a></h3>
<p>Vous allez maintenant normaliser les différents comptages.</p>
<p>Téléchargez dans un terminal de JupyterLab le script Bash (<a class="reference download internal" download="" href="../_downloads/8543b16244ff515cb25c8536d3549018/script_cluster_3.sh"><span class="xref download myst"><code class="docutils literal notranslate"><span class="pre">script_cluster_3.sh</span></code></span></a>) avec la commande <code class="docutils literal notranslate"><span class="pre">wget</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>wget<span class="w"> </span>https://raw.githubusercontent.com/pierrepo/unix-tutorial/master/tuto3/script_cluster_3.sh
</pre></div>
</div>
<p>Ouvrez ce script avec l’éditeur de texte de JupyterLab. Retrouvez les lignes spécifiques à l’utilisation d’un cluster de calcul et qui débutent par :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">#SBATCH</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">srun</span></code></p></li>
</ul>
<p>Puis lancez le script :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>script_cluster_3.sh
</pre></div>
</div>
<p>Affichez l’avancement de votre job avec la commande <code class="docutils literal notranslate"><span class="pre">sacct</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sacct<span class="w"> </span>--format<span class="o">=</span>JobID,JobName,State,Start,Elapsed,CPUTime,NodeList<span class="w"> </span>-j<span class="w"> </span>JOBID
</pre></div>
</div>
<p>avec <code class="docutils literal notranslate"><span class="pre">JOBID</span></code> le numéro de votre job.</p>
<p>L’exécution de ce script devrait moins d’une minute.</p>
<p>Le fichier qui contient le comptage normalisé des transcrits est <code class="docutils literal notranslate"><span class="pre">counts/genes.count_table</span></code>.</p>
</section>
</section>
<section id="bilan">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Bilan</a><a class="headerlink" href="#bilan" title="Permalink to this heading">#</a></h2>
<p>Vous avez lancé une analyse RNA-seq complète en utilisant le gestionnaire de ressources (Slurm) d’un cluster de calcul. Bravo ✨</p>
<p>Un peu plus tard, nous vous inviterons à reprendre cette analyse mais cette fois sur les 50 échantillons. Pour cela, il vous faudra modifier le script <code class="docutils literal notranslate"><span class="pre">script_cluster_2.sh</span></code> en remplaçant la ligne <code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">--array=0-2</span></code> (pour 3 échantillons) par <code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">--array=0-49</span></code> (pour 50 échantillons). Pensez aussi à relancer le script  <code class="docutils literal notranslate"><span class="pre">script_cluster_3.sh</span></code> pour normaliser les résultats de comptage.</p>
</section>
<section id="aller-plus-loin-connecter-les-jobs">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Aller plus loin : connecter les jobs</a><a class="headerlink" href="#aller-plus-loin-connecter-les-jobs" title="Permalink to this heading">#</a></h2>
<p>Pour cette analyse, il faut lancer 3 scripts :  <code class="docutils literal notranslate"><span class="pre">script_cluster_1.sh</span></code>,  <code class="docutils literal notranslate"><span class="pre">script_cluster_2.sh</span></code> et  <code class="docutils literal notranslate"><span class="pre">script_cluster_3.sh</span></code>. À chaque fois, il faut attendre que le précédent soit terminé, ce qui peut être pénible. Slurm offre la possibilité de chaîner les jobs les uns avec les autres avec l’option <code class="docutils literal notranslate"><span class="pre">--dependency</span></code>. Voici un exemple d’utilisation.</p>
<p>Tout d’abord on lance le script <code class="docutils literal notranslate"><span class="pre">script_cluster_1.sh</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>script_cluster_1.sh
Submitted<span class="w"> </span>batch<span class="w"> </span>job<span class="w"> </span><span class="m">33390286</span>
</pre></div>
</div>
<p>On récupère le job id (<code class="docutils literal notranslate"><span class="pre">33390286</span></code>) puis on lance immédiatement le script <code class="docutils literal notranslate"><span class="pre">script_cluster_2.sh</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>--dependency<span class="o">=</span>afterok:33390286<span class="w"> </span>script_cluster_2.sh
Submitted<span class="w"> </span>batch<span class="w"> </span>job<span class="w"> </span><span class="m">33390299</span>
</pre></div>
</div>
<p>On récupère le nouveau job id (<code class="docutils literal notranslate"><span class="pre">33390299</span></code>) puis on lance immédiatement le dernier script <code class="docutils literal notranslate"><span class="pre">script_cluster_3.sh</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>--dependency<span class="o">=</span>afterok:33390299<span class="w"> </span>script_cluster_3.sh
Submitted<span class="w"> </span>batch<span class="w"> </span>job<span class="w"> </span><span class="m">33390315</span>
</pre></div>
</div>
<p>Dans l’exemple ci-dessus, le job <code class="docutils literal notranslate"><span class="pre">33390315</span></code> (pour <code class="docutils literal notranslate"><span class="pre">script_cluster_3.sh</span></code>) ne va s’exécuter que quand le job <code class="docutils literal notranslate"><span class="pre">33390299</span></code> (pour <code class="docutils literal notranslate"><span class="pre">script_cluster_2.sh</span></code>) sera terminé avec succès. Et le job <code class="docutils literal notranslate"><span class="pre">33390299</span></code> ne va s’exécuter que quand le job <code class="docutils literal notranslate"><span class="pre">33390286</span></code> (pour <code class="docutils literal notranslate"><span class="pre">script_cluster_1.sh</span></code>) sera lui aussi terminé avec succès.</p>
<p>Voici le résultat obtenu avec <code class="docutils literal notranslate"><span class="pre">squeue</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ squeue -u ppoulain
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
          33390315      fast script_c ppoulain PD       0:00      1 (Dependency)
          33389748      fast  jupyter ppoulain  R      28:36      1 cpu-node-15
        33390299_0      fast script_c ppoulain  R       1:44      1 cpu-node-2
        33390299_1      fast script_c ppoulain  R       1:44      1 cpu-node-30
        33390299_2      fast script_c ppoulain  R       1:44      1 cpu-node-35
</pre></div>
</div>
<p>Dans cet exemple le premier job (<code class="docutils literal notranslate"><span class="pre">33390286</span></code>) est déjà terminé. Le job <code class="docutils literal notranslate"><span class="pre">33390299</span></code> est en cours d’exécution (pour 3 échantillons seulement) et le job <code class="docutils literal notranslate"><span class="pre">33390315</span></code> est en attente que le job <code class="docutils literal notranslate"><span class="pre">33390299</span></code> se termine.</p>
<p>Cette méthode évite d’attendre que le job précédent se termine pour lancer le suivant, mais il faut quand même les lancer manuellement pour récupére les différents job ids. On peut automatiser cela avec les commandes suivantes :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">jobid1</span><span class="o">=</span><span class="k">$(</span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>script_cluster_1.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">4</span><span class="k">)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running job 1: </span><span class="si">${</span><span class="nv">jobid1</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">jobid2</span><span class="o">=</span><span class="k">$(</span>sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>--dependency<span class="o">=</span>afterok:<span class="si">${</span><span class="nv">jobid1</span><span class="si">}</span><span class="w"> </span>script_cluster_2.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">4</span><span class="k">)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running job 2: </span><span class="si">${</span><span class="nv">jobid2</span><span class="si">}</span><span class="s2">&quot;</span>
sbatch<span class="w"> </span>-A<span class="w"> </span>202304_duo<span class="w"> </span>--dependency<span class="o">=</span>afterok:<span class="si">${</span><span class="nv">jobid2</span><span class="si">}</span><span class="w"> </span>script_cluster_3.sh
squeue<span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span>
</pre></div>
</div>
<p>La commande <code class="docutils literal notranslate"><span class="pre">squeue</span></code> à la fin permet simplement de vérifier que le premier job est en cours d’exécution et que les deux autres sont en attente.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./tuto3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="0_intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction et contexte</p>
      </div>
    </a>
    <a class="right-next"
       href="2_compter_surveiller_recuperer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Compter ⏲ les heures, surveiller 📬 les jobs et récupérer 📥 les résultats</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decouvrir-le-cluster">Découvrir le cluster</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analyser-un-echantillon">Analyser un échantillon</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analyser-50-echantillons-ou-pas-loin">Analyser 50 échantillons (ou pas loin)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparer-les-donnees">Préparer les données</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lancer-le-script-de-l-etape-1">Lancer le script de l’étape 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lancer-le-script-de-l-etape-2">Lancer le script de l’étape 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lancer-le-script-de-l-etape-3">Lancer le script de l’étape 3</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bilan">Bilan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aller-plus-loin-connecter-les-jobs">Aller plus loin : connecter les jobs</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Pierre Poulain
</p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
Ce contenu est mis à disposition selon les termes de la licence <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.fr" target="_blank">Creative Commons Attribution - Partage dans les Mêmes Conditions 4.0 International</a> (CC BY-SA 4.0).
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>